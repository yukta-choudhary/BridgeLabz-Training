/*
    Visit Management & Medical Records System

    UC-4.1: Record Patient Visit
    UC-4.2: View Patient Medical History
    UC-4.3: Add Prescription Details
*/

CREATE DATABASE visit_mgmt_db;

USE visit_mgmt_db;

CREATE TABLE patients (
    patient_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100)
);

CREATE TABLE doctors (
    doctor_id INT PRIMARY KEY AUTO_INCREMENT,
    doctor_name VARCHAR(100)
);

CREATE TABLE appointments (
    appointment_id INT PRIMARY KEY AUTO_INCREMENT,
    patient_id INT,
    doctor_id INT,
    appointment_date DATE,
    status VARCHAR(20),
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id)
);

CREATE TABLE visits (
    visit_id INT PRIMARY KEY AUTO_INCREMENT,
    appointment_id INT,
    visit_date DATE,
    diagnosis VARCHAR(255),
    notes TEXT,
    FOREIGN KEY (appointment_id) REFERENCES appointments(appointment_id)
);

CREATE TABLE prescriptions (
    prescription_id INT PRIMARY KEY AUTO_INCREMENT,
    visit_id INT,
    medicine_name VARCHAR(100),
    dosage VARCHAR(50),
    duration VARCHAR(50),
    FOREIGN KEY (visit_id) REFERENCES visits(visit_id)
);

--------------------------------------------------
-- UC-4.1: Record Patient Visit
--------------------------------------------------

INSERT INTO patients (name)
VALUES ('Anita Sharma');

INSERT INTO doctors (doctor_name)
VALUES ('Dr. Mehta');

INSERT INTO appointments (patient_id, doctor_id, appointment_date, status)
VALUES (1, 1, CURDATE(), 'SCHEDULED');

START TRANSACTION;

INSERT INTO visits (appointment_id, visit_date, diagnosis, notes)
VALUES (1, CURDATE(), 'High Blood Pressure', 'Patient advised regular exercise');

UPDATE appointments
SET status = 'COMPLETED'
WHERE appointment_id = 1;

COMMIT;

--------------------------------------------------
-- UC-4.3: Add Prescription Details
--------------------------------------------------

INSERT INTO prescriptions (visit_id, medicine_name, dosage, duration)
VALUES
(1, 'Amlodipine', '5mg once daily', '30 days'),
(1, 'Aspirin', '75mg once daily', '15 days');

--------------------------------------------------
-- UC-4.2: View Patient Medical History
--------------------------------------------------

SELECT
    p.name AS patient_name,
    d.doctor_name,
    a.appointment_date,
    v.visit_date,
    v.diagnosis,
    pr.medicine_name,
    pr.dosage,
    pr.duration
FROM visits v
JOIN appointments a ON v.appointment_id = a.appointment_id
JOIN patients p ON a.patient_id = p.patient_id
JOIN doctors d ON a.doctor_id = d.doctor_id
LEFT JOIN prescriptions pr ON v.visit_id = pr.visit_id
WHERE p.patient_id = 1
ORDER BY v.visit_date DESC;

/*
+--------------+-------------+------------------+------------+---------------------+---------------+-----------------+----------+
| patient_name | doctor_name | appointment_date | visit_date | diagnosis           | medicine_name | dosage          | duration |
+--------------+-------------+------------------+------------+---------------------+---------------+-----------------+----------+
| Anita Sharma | Dr. Mehta   | 2026-02-08       | 2026-02-08 | High Blood Pressure | Amlodipine    | 5mg once daily  | 30 days  |
| Anita Sharma | Dr. Mehta   | 2026-02-08       | 2026-02-08 | High Blood Pressure | Aspirin       | 75mg once daily | 15 days  |
+--------------+-------------+------------------+------------+---------------------+---------------+-----------------+----------+
*/
