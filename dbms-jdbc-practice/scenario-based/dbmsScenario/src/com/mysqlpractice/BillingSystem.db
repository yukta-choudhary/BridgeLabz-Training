/*
    Billing & Payments System

    UC-5.1: Generate Bill for Visit
    UC-5.2: Record Payment
    UC-5.3: View Outstanding Bills
    UC-5.4: Generate Revenue Report
*/

CREATE DATABASE billing_mgmt_db;

USE billing_mgmt_db;

CREATE TABLE patients (
    patient_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100)
);

CREATE TABLE doctors (
    doctor_id INT PRIMARY KEY AUTO_INCREMENT,
    doctor_name VARCHAR(100),
    specialty VARCHAR(100),
    consultation_fee DECIMAL(10,2)
);

CREATE TABLE visits (
    visit_id INT PRIMARY KEY AUTO_INCREMENT,
    patient_id INT,
    doctor_id INT,
    visit_date DATE,
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id)
);

CREATE TABLE bill_items (
    item_id INT PRIMARY KEY AUTO_INCREMENT,
    visit_id INT,
    description VARCHAR(100),
    amount DECIMAL(10,2),
    FOREIGN KEY (visit_id) REFERENCES visits(visit_id)
);

CREATE TABLE bills (
    bill_id INT PRIMARY KEY AUTO_INCREMENT,
    visit_id INT,
    total_amount DECIMAL(10,2),
    payment_status VARCHAR(20) DEFAULT 'UNPAID',
    payment_date DATE,
    payment_mode VARCHAR(50),
    FOREIGN KEY (visit_id) REFERENCES visits(visit_id)
);

CREATE TABLE payment_transactions (
    transaction_id INT PRIMARY KEY AUTO_INCREMENT,
    bill_id INT,
    amount DECIMAL(10,2),
    payment_mode VARCHAR(50),
    transaction_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (bill_id) REFERENCES bills(bill_id)
);

--------------------------------------------------
-- UC-5.1: Generate Bill for Visit
--------------------------------------------------

INSERT INTO patients (name)
VALUES ('Anita Sharma');

INSERT INTO doctors (doctor_name, specialty, consultation_fee)
VALUES ('Dr. Mehta', 'Cardiology', 800.00);

INSERT INTO visits (patient_id, doctor_id, visit_date)
VALUES (1, 1, CURDATE());

INSERT INTO bill_items (visit_id, description, amount)
VALUES
(1, 'Consultation Fee', 800.00),
(1, 'ECG Test', 500.00);

INSERT INTO bills (visit_id, total_amount)
SELECT
    visit_id,
    SUM(amount)
FROM bill_items
WHERE visit_id = 1
GROUP BY visit_id;

--------------------------------------------------
-- UC-5.2: Record Payment
--------------------------------------------------

START TRANSACTION;

UPDATE bills
SET payment_status = 'PAID',
    payment_date = CURDATE(),
    payment_mode = 'CASH'
WHERE bill_id = 1;

INSERT INTO payment_transactions (bill_id, amount, payment_mode)
VALUES (1, 1300.00, 'CASH');

COMMIT;

--------------------------------------------------
-- UC-5.3: View Outstanding Bills
--------------------------------------------------

SELECT
    p.name AS patient_name,
    COUNT(b.bill_id) AS unpaid_bills,
    SUM(b.total_amount) AS total_due
FROM bills b
JOIN visits v ON b.visit_id = v.visit_id
JOIN patients p ON v.patient_id = p.patient_id
WHERE b.payment_status = 'UNPAID'
GROUP BY p.patient_id;

/*
Empty set
*/

--------------------------------------------------
-- UC-5.4: Generate Revenue Report
--------------------------------------------------

SELECT
    d.doctor_name,
    d.specialty,
    SUM(b.total_amount) AS total_revenue
FROM bills b
JOIN visits v ON b.visit_id = v.visit_id
JOIN doctors d ON v.doctor_id = d.doctor_id
WHERE b.payment_status = 'PAID'
AND v.visit_date BETWEEN '2026-02-01' AND '2026-02-28'
GROUP BY d.doctor_id, d.specialty
HAVING SUM(b.total_amount) > 500;

/*
+-------------+------------+---------------+
| doctor_name | specialty  | total_revenue |
+-------------+------------+---------------+
| Dr. Mehta   | Cardiology |       1300.00 |
+-------------+------------+---------------+
*/
