/*
    Appointment Scheduling System

    UC-3.1: Book New Appointment
    UC-3.2: Check Doctor Availability
    UC-3.3: Cancel Appointment
    UC-3.4: Reschedule Appointment
    UC-3.5: View Daily Appointment Schedule
*/

CREATE DATABASE appointment_mgmt_db;

USE appointment_mgmt_db;

CREATE TABLE patients (
    patient_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100),
    phone VARCHAR(15)
);

CREATE TABLE doctors (
    doctor_id INT PRIMARY KEY AUTO_INCREMENT,
    doctor_name VARCHAR(100),
    specialization VARCHAR(100),
    max_daily_appointments INT DEFAULT 10
);

CREATE TABLE appointments (
    appointment_id INT PRIMARY KEY AUTO_INCREMENT,
    patient_id INT,
    doctor_id INT,
    appointment_date DATE,
    appointment_time TIME,
    status VARCHAR(20),
    FOREIGN KEY (patient_id) REFERENCES patients(patient_id),
    FOREIGN KEY (doctor_id) REFERENCES doctors(doctor_id)
);

CREATE TABLE appointment_audit (
    audit_id INT PRIMARY KEY AUTO_INCREMENT,
    appointment_id INT,
    action VARCHAR(50),
    action_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

--------------------------------------------------
-- UC-3.1: Book New Appointment
--------------------------------------------------

INSERT INTO patients (name, phone)
VALUES ('Anita Sharma', '9876543210');

INSERT INTO doctors (doctor_name, specialization, max_daily_appointments)
VALUES ('Dr. Mehta', 'Orthopedics', 5);

SELECT *
FROM appointments
WHERE doctor_id = 1
AND appointment_date = '2026-02-10'
AND appointment_time = '10:00:00'
AND status = 'SCHEDULED';

/*
Empty set
*/

INSERT INTO appointments
(patient_id, doctor_id, appointment_date, appointment_time, status)
VALUES (1, 1, '2026-02-10', '10:00:00', 'SCHEDULED');

--------------------------------------------------
-- UC-3.2: Check Doctor Availability
--------------------------------------------------

SELECT
    appointment_time,
    COUNT(*) AS booked_slots
FROM appointments
WHERE doctor_id = 1
AND appointment_date = '2026-02-10'
AND status = 'SCHEDULED'
GROUP BY appointment_time;

/*
+------------------+--------------+
| appointment_time | booked_slots |
+------------------+--------------+
| 10:00:00         |            1 |
+------------------+--------------+
*/

--------------------------------------------------
-- UC-3.3: Cancel Appointment
--------------------------------------------------

START TRANSACTION;

UPDATE appointments
SET status = 'CANCELLED'
WHERE appointment_id = 1;

INSERT INTO appointment_audit (appointment_id, action)
VALUES (1, 'APPOINTMENT CANCELLED');

COMMIT;

--------------------------------------------------
-- UC-3.4: Reschedule Appointment
--------------------------------------------------

SELECT *
FROM appointments
WHERE doctor_id = 1
AND appointment_date = '2026-02-12'
AND appointment_time = '11:00:00'
AND status = 'SCHEDULED';

/*
Empty set
*/

START TRANSACTION;

UPDATE appointments
SET appointment_date = '2026-02-12',
    appointment_time = '11:00:00'
WHERE appointment_id = 1;

COMMIT;

--------------------------------------------------
-- UC-3.5: View Daily Appointment Schedule
--------------------------------------------------

SELECT
    a.appointment_time,
    p.name AS patient_name,
    d.doctor_name,
    a.status
FROM appointments a
JOIN patients p ON a.patient_id = p.patient_id
JOIN doctors d ON a.doctor_id = d.doctor_id
WHERE a.appointment_date = '2026-02-10'
ORDER BY a.appointment_time;

/*
Empty set
*/
